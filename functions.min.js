function fqueue(d){d.preventDefault();var c=d.target.files!=undefined?d.target.files:d.dataTransfer.files,b=0;for(;b<c.length;b++){var f=c[b],a=(substr(f.name,-3).toLowerCase()=="cr2");if(f.type.match(/image.*/)||a){if(typeof empty!="undefined"&&empty!=undefined){empty.style.display="none"}read(f,a)}else{alert("File: "+f.name+" is not an image")}}}function fs(){if((document.fullscreenEnabled==false)||(document.mozFullScreen==false)||(document.webkitIsFullScreen==false)){var a=document.documentElement;if(a.requestFullscreen){a.requestFullscreen()}else{if(a.mozRequestFullScreen){a.mozRequestFullScreen()}else{if(a.webkitRequestFullscreen){a.webkitRequestFullscreen()}else{if(a.msRequestFullscreen){a.msRequestFullscreen()}}}}}else{if(document.exitFullscreen){document.exitFullscreen()}else{if(document.mozCancelFullScreen){document.mozCancelFullScreen()}else{if(document.webkitExitFullscreen){document.webkitExitFullscreen()}}}}}function read(c,b){while(upname==null||upname.length<2){upname=prompt("Please enter your name","")}if(b&&!features.srs&&!smalldev&&features.uploading){raws.push(c)}else{var a=new FileReader();a.addEventListener("load",function(d){upload(d.target.result,c.name,c.lastModified)});a.readAsDataURL(c)}}function do_upload(a){var b=new xhr();b.addEventListener("readystatechange",function(){if(this.readyState==4&&this.status==200){uploads.active--;uploads.queued--;var c=json_decode(this.responseText);if(c.success){a.success=true;a.binary="";$(a.container).remove();imgs.push(c.file);addimg(c.file);mdata[c.file]=c.exif;console.log(c.orig_file+" was successfully uploaded")}else{a.success=false;alert("There was an error while uploading: "+c.error+", file: "+c.file)}}});b.upload.addEventListener("progress",function(d){if(d.lengthComputable){var c=d.loaded/d.total;a.label.innerHTML=round(c*100,0)+"%";a.uploaded=c}else{console.warn("Unable to compute progress information since the total size is unknown")}});b.addEventListener("abort",function(){uploads.queued--;a.success=false;$(a.container).remove();console.log("an error occurred with upload id #"+a.id)});b.addEventListener("timeout",b.abort);b.addEventListener("error",b.abort);b.open("POST","upload.php?name="+a.fname+"&date="+a.date+"&by="+upname,true);b.send(a.binary!=undefined?a.binary:a.image.src);a.uploading=true;uploads.active++}function parsed(a,b,c){console.log(a,b,c,c.getMetadata());upload(a.toDataURL("image/jpeg"),b.name+".jpg",b.lastModified);a.remove();raws.splice(0,1);busy=false}function loop(){if(uploads.queued!=0){$(sidebar).fadeIn()}var e=Object.keys(uploads),g=0,d=e.length,c=0;for(;g<d;g++){var b=e[g];if(b!="active"&&b!="queued"){var q=uploads[b];if(q.uploaded!=1){percentage=q.uploaded;c+=percentage}if(!q.uploading&&uploads.active<1){do_upload(q)}}}c/=uploads.queued;c*=100;var a=uploads.queued==0?"0%":c+"%";if(prog.style.width!=a){prog.style.width=a}var m=time()-lastmove;if(m>2){if(!chidden){hidectl()}}else{if(chidden){showctl()}}if(raws.length>0&&!busy&&!smalldev&&typeof rawViewer=="object"&&features.uploading){busy=true;rawViewer.readFile(raws[0],parsed)}var f=location.hash;if(f[1]=="!"){if(f.length<=2){console.warn("No arguments provided but #!. Stopping.")}else{argr=substr(f,2);args=explode(",",argr);for(var g=0;g<args.length;g++){var p=explode("=",args[g]),n=p[0],j=p[1];if(j==undefined){j=true}if(p.length>2){console.warn("Multiple values specified, using first one")}if(n=="ts"){if(j!=""){thumbsize=j}}if(n=="rs"){if(j!=""){realsize=j}}if(n=="image"){if(j!=""&&j!=undefined){var h=(container.style.display=="none");if(h||$.data(img,"original")!=j){var o=findthumb(j);if(o!=undefined&&($.data(img,"original")!=$.data(o,"original")||h)){openpic(o)}}}}if(n=="info"){if(j=="true"&&!info){infolay.classList.remove("closed");info=true}else{if(j=="false"&&info){infolay.classList.add("closed");info=false}}}if(n=="preload"){if(j=="false"||j==false){preload=false}if(j=="true"||j==true){preload=true}}if(n=="overview"){if(j=="true"||j==true){if(container.style.display!="none"){container.click()}}}if(n=="smalldev"){j=="true"||j==true?smalldev=true:false}}}}requestAnimationFrame(loop)}function upload(){var g=arguments[0],f=arguments[1],b=arguments[2],c=new Image(),e=uniqid(),d=CE("div"),a=CE("span");if(substr(f,-4).toLowerCase()==".cr2"){c.src=svg?"icons/white.svg":"icons/white.png";uploads[e]={binary:g,fname:f,date:b,uploaded:0,uploading:false,id:e,label:a,container:d};uploads.queued++}else{c.src=g;c.addEventListener("load",function(){uploads[e]={image:c,fname:f,date:b,uploaded:0,uploading:false,id:e,label:a,container:d};uploads.queued++})}d.classList.add("upfile");c.classList.add("upthumb");a.classList.add("uptext");a.classList.add("fade");c.classList.add("fade");a.appendChild(document.createTextNode("Waiting..."));d.appendChilds(c,a);sidebar.appendChild(d)}function startWorker(){if(typeof(Worker)!=="undefined"&&typeof(w)=="undefined"&&preload){w=new Worker("preload.min.js");w.onmessage=function(c){var d=basename(c.data[1]),a=c.data[0];var b=(window.URL||window.webkitURL).createObjectURL(a);imgs[d]=b;mdata[d]=json_decode(c.data[2]);console.info("WebWorker has successfully downloaded "+d+" to "+b)};w.postMessage(imgs);console.info("Preload WebWorker started")}}function update(){var b=new xhr(),a=url;b.open("GET","download.php/rename/"+a+"/"+this.id+"/"+this.textContent,true);b.addEventListener("readystatechange",function(){if(this.readyState==4&&this.status==200){var c=json_decode(this.responseText);if(!c.success){alert("Something went wrong while renaming")}mdata[a]=c.exif}});b.send()}function winwidth(){var b=window,h=document,f=h.documentElement,c=h.getElementsByTagName("body")[0],a=b.innerWidth||f.clientWidth||c.clientWidth;return a}function kinput(f){var c=f.target,d=c.contentEditable,a=c.tagName,b=f.keyCode||f.which;if(!d||a!="SPAN"){if(b==105){infooverlay()}if(b==102){fs()}if(b==27){f.preventDefault();container.click()}if(b==39||b==110){next()}if(b==37||b==112){prev()}if(b==8||b==46){f.preventDefault();del()}}else{lastmove=time()}if(d&&a=="SPAN"){if(b==13){f.preventDefault();c.blur()}}}function addimg(a){var b=CE("img");b.classList.add("loadingbg");if(thumbsize!=0){b.src="download.php/resize/"+(parseInt(thumbsize)+(parseInt(thumbsize)/10))+"/"+a;b.style.width=thumbsize+"px"}else{b.src=smalldev?"download.php/resize/110/"+a:"thumbs.dir/"+a+".jpg";b.style.maxWidth="10%"}$.data(b,"original",a);b.classList.add("image");b.addEventListener("click",openpic);grid.appendChild(b)}function openpic(h){ib=0;if(this.tagName=="IMG"){h=this}if(h==undefined){console.warn("srcthumb is undefined");return}$("html,body").animate({scrollTop:$(h).offset().top},1000);url=$.data(h,"original");var a=false,A=imgs[url];if(substr(A,0,4)=="blob"){console.info("Reading image "+url+" from "+A);img.src=A;a=true}else{if(realsize==0){img.src=url}else{if(realsize=="dyn"){img.src="download.php/resize/"+(smalldev?winwidth()*4:(winwidth()/100)*95)+"/"+url}else{img.src="download.php/resize/"+realsize+"/"+url}}}$.data(img,"original",url);location.hash="#!image="+basename(url)+(info?",info=true":"");container.style.display="";grid.style.webkitFilter=grid.style.filter="blur(9px)";while(infolay.firstChild){infolay.removeChild(infolay.firstChild)}var E=mdata[url]!=undefined?mdata[url]:json_decode(file_get_contents("download.php/exif/"+url)),g="";var v=E.meta,j="";if(v==false){v={}}if("title" in v&&v.title!=""){j+=v.title}else{j+="Unbenannt"}var e=CE("span");e.appendChild(document.createTextNode(j));if(features.renaming){e.contentEditable=true}e.id="title";e.addEventListener("blur",update);var r=CE("span");r.id="upby";r.appendChild(document.createTextNode("upby" in v&&v.upby!=""?v.upby:"Unbekannt"));if(features.renaming){r.contentEditable=true}r.addEventListener("blur",update);var q=CE("span"),b="description" in v&&v.description!=""?v.description:"Unbeschrieben";q.id="description";q.addEventListener("blur",update);q.appendChild(document.createTextNode(b));if(features.renaming){q.contentEditable=true}infolay.appendChilds(e,document.createTextNode(" von "),r,document.createTextNode(": "),q);if(E!=false&&E!=null){var u=E.width,n=E.height,c=E.make,d=E.model,s=E.GPS,C=E.date,B=E.ISO,k=E.aperture,D=E.exposure,f=E.filesize,p=E.flash,o=E.software;if(C!=false){g+=", fotografiert am "+C}if(C!=false&&c!=false&&d!=false){var y=c+" "+d;if(c==d){y=d}if(d.indexOf(c)!=-1){y=d}g+=", mit einer / einem "+y}else{if(c!=false&&d!=false){var y=c+" "+d;if(c==d){y=d}if(d.indexOf(c)!=-1){y=d}g+=", fotografiert mit einer / einem "+y}}if(B!=false){g+=", ISO: "+B}if(k!=false){g+=", Blende: "+k}if(D!=false){g+=", Belichtungszeit: "+D}if(p!=false){g+=", Blitz aktiviert"}if(f!=false){g+=", Dateigröße: "+f}if(u!=false&&n!=false){g+=", Abmessungen: "+u+"x"+n}if(o!=false&&o!=null){g+=", software: "+o}infolay.appendChild(document.createTextNode(g+" "));var x=CE("a");x.download=url;x.href=a?A:"download.php/"+basename(url);x.appendChild(document.createTextNode("In Originalgröße downloaden"));infolay.appendChild(x);if(s!=false){var z=CE("a");z.target="_blank";z.href="//maps.apple.com/?q="+urlencode(s);z.appendChild(document.createTextNode("Ort in Karten öffnen"));infolay.appendChild(z)}if(features.deleting){infolay.appendChild(document.createTextNode("    "));var l=CE("button");l.addEventListener("click",del);l.classList.add("delbut");l.appendChild(document.createTextNode("Löschen"));infolay.appendChild(l)}}}function infooverlay(){infolay.classList.toggle("closed");info=infolay.classList.contains("closed")?false:true;if(container.style.display!="none"){location.hash="#!image="+url+(info?",info=true":"")}}function findthumb(a){acs("image",function(b){if($.data(b,"original")==a){return b}})}function del(){var a=$.data(img,"original"),b=json_decode(file_get_contents("download.php/delete/"+a));if(b.success){next();findthumb(a).remove();imgs.splice(findimg(a),1);ety(true)}else{alert("Ein fehler ist beim löschen aufgetreten.")}}function next(c){var b=(findimg($.data(img,"original")==undefined?basename(img.src):$.data(img,"original"))+1);if(b==imgs.length){b=0}var a=findthumb(imgs[b]);if(!badbrowser){img.style.width=img.width+"px";img.style.height=img.height+"px";img.src=a.src}openpic(a)}function rstx(){if(ib&1){this.style.width="";this.style.height=""}ib++}function moov(){lastmove=time()}function hidectl(){chidden=true;infobut.classList.add("hidden");prevb.classList.add("hidden");nextb.classList.add("hidden");if(!smalldev){img.classList.add("pmode");container.style.background="rgba(0,0,0,0.9)"}}function showctl(){chidden=false;infobut.classList.remove("hidden");prevb.classList.remove("hidden");nextb.classList.remove("hidden");if(!smalldev){container.style.background="";img.classList.remove("pmode")}}function prev(b){var c=findimg($.data(img,"original")==undefined?basename(img.src):$.data(img,"original"))-1;if(c<0){c=(imgs.length-1)}var a=findthumb(imgs[c]);if(!badbrowser){img.style.width=img.width+"px";img.style.height=img.height+"px";img.src=a.src}openpic(a)}function findimg(a){for(i=0;i<=imgs.length;i++){if(imgs[i]==urldecode(a)){return i}}}function ety(){if(!imgs.length){empty=CE("div"),h1=CE("h1"),h2=CE("h2");h1.appendChild(document.createTextNode("Noch nichts da..."));h2.appendChild(document.createTextNode("Ziehe fotos auf diese Seite um sie hochzuladen"));empty.id="empty";empty.classList.add("cent");empty.appendChild(h1);empty.appendChild(h2);document.body.appendChild(empty);if(arguments[0]){container.click()}}}function iclick(a){if(a.target.id==this.id){this.style.display="none";grid.style.webkitFilter=grid.style.filter="";location.hash="#!overview"}}if(typeof HTMLElement.prototype.remove!="function"){HTMLElement.prototype.remove=function(){$(this).remove()}}function mimg(b){var c=b.target,a=(ix||0)+b.dx;ix=a;a-=iwi/2;c.style.webkitTransform=c.style.transform="translate("+a+"px, -50%)"}function smimg(a){var b=a.target;iwi=$(b).width();b.classList.remove("fade");b.classList.remove("cent")}function emimg(b){var c=b.target;c.classList.add("cent");ix=0;c.setAttribute("style","");c.classList.add("fade");var a=b.clientX;if(a<(winwidth()/100)*10){prev()}if(a>(winwidth()/100)*90){next()}}function acs(d,c){var a=document.getElementsByClassName(d),b=0;for(;b<a.length;b++){c(a[b])}}function hidestatus(){acs("uptext",function(a){a.style.opacity=0});acs("upfile",function(a){a.style.margin=0})}function showstatus(){acs("uptext",function(a){a.style.opacity=1});acs("upfile",function(a){a.style.margin="0.5%"})}function init(){window.thumbsize=0;window.svg=typeof SVGRect!="undefined"&&window.navigator.userAgent.indexOf("Windows")<0?true:false;window.realsize="dyn";window.argr="";window.args=[];window.info=false;window.smalldev=$(window).width()<768;window.preload=false;window.loaded=false;window.url="";window.grid=CE("div");window.container=CE("div");window.desc=CE("span");window.prevb=CE("img");window.nextb=CE("img");window.img=CE("img");window.mdata={};window.empty;window.prog=CE("span");window.uploads={active:0,queued:0};window.raws=[];window.busy=false;window.upname="";window.imgs=[];window.lastmove=time();window.chidden=false;window.iwi=0;window.ix=0;window.ib=0;window.sidebar=CE("div");window.badbrowser=navigator.userAgent.toLowerCase().indexOf("webkit")!==-1;window.xhr=function(){return window.XMLHttpRequest?new XMLHttpRequest():new ActiveXObject("Microsoft.XMLHTTP")};var gs=grid.style;gs.webkitTransitionDuration=gs.oTransitionDuration=gs.msTransitionDuration=gs.transitionDuration="0.7s";sidebar.classList.add("fade");sidebar.id="sidebar";prog.id="progress";container.id="bigpic";container.style.cursor="pointer";container.style.display="none";container.addEventListener("click",iclick);prevb.src=svg?"icons/prev.svg":"icons/prev.png";prevb.classList.add("prev");prevb.classList.add("symbol");prevb.classList.add("vertcent");prevb.classList.add("fade");prevb.style.width="10%";prevb.addEventListener("click",prev);nextb.src=svg?"icons/next.svg":"icons/next.png";nextb.classList.add("next");nextb.classList.add("symbol");nextb.classList.add("vertcent");nextb.classList.add("fade");nextb.style.width="10%";nextb.addEventListener("click",next);img.classList.add("largepic");img.classList.add("cent");img.classList.add("fade");img.classList.add("loadingbg");if(smalldev){img.classList.add("pmode")}img.addEventListener("dblclick",fs);window.infobut=CE("img");infobut.src=svg?"icons/info.svg":"icons/info.png";infobut.classList.add("symbol");infobut.style.width="7%";infobut.style.bottom="2%";infobut.addEventListener("click",infooverlay);infobut.classList.add("horcent");infobut.classList.add("fade");window.infolay=CE("div");infolay.classList.add("infolay");infolay.classList.add("horcent");infolay.classList.add("closed");container.classList.add("fade");container.appendChilds(prevb,nextb,img,infobut,infolay);document.body.appendChilds(prog,grid,container,sidebar);$(sidebar).fadeOut();var mdts=Object.keys(files).sort(),i=0;for(;i<mdts.length;i++){var imag=files[mdts[i]];if(typeof imag!="string"){imag.forEach(function(image){addimg(image);imgs.push(image)})}else{addimg(imag);imgs.push(imag)}}ety();startWorker();loop();window.addEventListener("keypress",kinput);window.addEventListener("mousemove",moov);window.addEventListener("click",moov);window.addEventListener("touchmove",moov);window.addEventListener("touchstart",moov);window.addEventListener("touchend",moov);sidebar.addEventListener("mouseover",showstatus);sidebar.addEventListener("mouseout",hidestatus);if(!badbrowser){img.addEventListener("load",rstx)}var o=false,r=false;window.intr=interact(img).draggable({inertia:true,onstart:smimg,onend:emimg,onmove:mimg,axis:"x"});if(features.uploading){var upbut=document.querySelector(".upload");document.querySelector(".fileUpload").style.display="";upbut.addEventListener("change",fqueue);document.body.addEventListener("dragover",function(e){e.preventDefault()});document.body.addEventListener("drop",fqueue);if(!features.srs&&!smalldev){var x=new xhr();x.open("GET","raw.min.js",true);x.addEventListener("readystatechange",function(){if(this.readyState==4&&this.status==200){eval(this.responseText);window.rawViewer=new Rawson.Viewer("preview",{formats:{read:["RAW"]},controls:[new Rawson.Control.FileProgress()]})}});x.send()}}if(features.srs==undefined){var x=new xhr();x.open("GET","download.php/rawtest",true);x.addEventListener("readystatechange",function(){if(this.readyState==4&&this.status==200){this.response=="true"?features.srs=true:features.srs=false}});x.send()}};